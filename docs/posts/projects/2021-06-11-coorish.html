<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Shestakov Alex Blog - People membership validation in JIRA fields against Active Directory</title>
  <link rel="stylesheet" href="../../css/default.css" />

  <script type="text/javascript" src="../../vendor/jquery/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="../../vendor/fresco/js/fresco.min.js"></script>
  <link rel="stylesheet" type="text/css" href="../../vendor/fresco/css/fresco.css" />

  <link rel="stylesheet" href="../../vendor/highlight/styles/atom-one-dark.min.css">
  <script src="../../vendor/highlight/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
</head>

<body>
  <header>
    <div class="logo">
      <a href="../../">Shestakov Alex</a>
    </div>
    <nav>
      &amp;<a href="../../languages/english.html">english</a> &amp;<a href="../../languages/russian.html">russian</a>
      @<a href="../../categories/WAT.html">WAT</a> @<a href="../../categories/code.html">code</a> @<a href="../../categories/projects.html">projects</a>
      <a href="../../about.html">About</a>
    </nav>
  </header>

  <main role="main">
    <h1>People membership validation in JIRA fields against Active Directory</h1>
    <article>
  <span class="header">
    June 11, 2021 &amp;<a href="../../languages/english.html">english</a> @<a href="../../categories/projects.html">projects</a> #<a href="../../tags/haskell.html">haskell</a> #<a href="../../tags/aeson.html">aeson</a> #<a href="../../tags/servant.html">servant</a>
  </span>
  <section>
    <p>Current version of JIRA inside Itransition does not allow to validate “whether a person belongs to a certain group” for multi-people fields, only for single-user fields. <a href="https://github.com/maksar/Coorish">Coorish</a> – is a small utility to determine ineligible people being specified in JIRA tickets.</p>
<!--more-->
<p><a href="../../images/coorish/1.png" class="center fresco" data-fresco-group="thumbnail" data-fresco-options="ui: 'inside', thumbnails: false"><img src="../../previews/coorish/1.png" /></a></p>
<h2 id="history">History</h2>
<p>Project card – is a custom JIRA ticket, containing a bunch of fields about the project (I do work in an outsource company, so…) – technologies used, people involved, plans and troubles, etc. Since migration plans are far away, I decided to write a small utility to ensure that there are no “misuses” – only people from <code>Project.Management.All</code> AD group are specified in “Project Manager” fields in project cards.</p>
<h2 id="internals">Internals</h2>
<p>So it is a small terminal application, which “talks” to JIRA asking about project cards, “talks” to AD via LDAP to get members of the groups and spills the results to the terminal.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Config</span> {<span class="op">..</span>} <span class="ot">&lt;-</span> readConfig <span class="op">@</span><span class="dt">Config</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  ldapConfig <span class="ot">&lt;-</span> readConfig <span class="op">@</span><span class="dt">Ldap.LdapConfig</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  jiraConfig <span class="ot">&lt;-</span> readConfig <span class="op">@</span><span class="dt">Jira.JiraConfig</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  activeDirectoryPeople <span class="ot">&lt;-</span> Ldap.groupMembers ldapGroups ldapConfig</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  projectCards <span class="ot">&lt;-</span> Jira.projectCards jiraField jiraConfig</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  forM_ projectCards <span class="op">$</span> \card <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> people <span class="ot">=</span> Jira.people card</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    when (<span class="fu">null</span> people) <span class="op">$</span> <span class="fu">pure</span> ()</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> (validPeople, invalidPeople) <span class="ot">=</span> partition (\person <span class="ot">-&gt;</span> Jira.displayName person <span class="ot">`elem`</span> activeDirectoryPeople) people</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    unless (<span class="fu">null</span> invalidPeople) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>      putTextLn <span class="op">$</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Card '&quot;</span> <span class="op">&lt;&gt;</span> Jira.projectName card <span class="op">&lt;&gt;</span> <span class="st">&quot;' (&quot;</span> <span class="op">&lt;&gt;</span> Jira.key card <span class="op">&lt;&gt;</span> <span class="st">&quot;) &quot;</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;&gt;</span> <span class="st">&quot;has some people in '&quot;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;&gt;</span> jiraField</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;&gt;</span> <span class="st">&quot;' field not from '&quot;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;&gt;</span> <span class="fu">mconcat</span> (intersperse <span class="st">&quot;; &quot;</span> ldapGroups)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;&gt;</span> <span class="st">&quot;' AD group: '&quot;</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;&gt;</span> <span class="fu">mconcat</span> (intersperse <span class="st">&quot;; &quot;</span> (<span class="fu">map</span> Jira.displayName invalidPeople))</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;&gt;</span> <span class="st">&quot;'&quot;</span></span></code></pre></div>
<p>I used the <a href="../../posts/projects/2020-02-07-ldap-bot.html">same</a> ldap-client library for LDAP communication, but this time utilized text-ldap for parsing DNs from ldap into proper data structures instead of treating results like strings. Envy library with some sprinkles of template-haskell magic allowed me to read configuration properties from environment variables. Servant-client again proved to be very handy to “talk” to the external HTTP API. Template haskell was <a href="https://github.com/maksar/coorish/commit/d961d01763ad66c113abf9551315b5f1b5a4f2dd#diff-31b2976c7d81ff33a9d0115c0b39c980023862d7bad0cef4e20fda15fa2bb863R91-R97">used</a> for one more thing – embedding configuration values into <code>FromJSON</code> instances – I didn’t know how to parametrize them in an elegant way.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Config</span> <span class="ot">=</span> <span class="dt">Config</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>   {<span class="ot"> jiraField ::</span> <span class="dt">Text</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ot">     ldapGroups ::</span> [<span class="dt">Text</span>]</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>   <span class="kw">deriving</span> (<span class="dt">Generic</span>, <span class="dt">Show</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="ot">configValue ::</span> <span class="dt">Lift</span> t <span class="ot">=&gt;</span> (<span class="dt">Config</span> <span class="ot">-&gt;</span> t) <span class="ot">-&gt;</span> <span class="dt">Q</span> <span class="dt">Exp</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a> configValue f <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>   groups <span class="ot">&lt;-</span> runIO (f <span class="op">&lt;$&gt;</span> readConfig <span class="op">@</span><span class="dt">Config</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>   [e|groups|]</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">FromJSON</span> <span class="dt">ProjectCard</span> <span class="kw">where</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>   parseJSON <span class="ot">=</span> withObject <span class="st">&quot;card&quot;</span> <span class="op">$</span> \card <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>     key <span class="ot">&lt;-</span> card <span class="op">.:</span> <span class="st">&quot;key&quot;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>     fields <span class="ot">&lt;-</span> card <span class="op">.:</span> <span class="st">&quot;fields&quot;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>     projectName <span class="ot">&lt;-</span> fields <span class="op">.:</span> <span class="st">&quot;summary&quot;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>     peopleMaybe <span class="ot">&lt;-</span> fields <span class="op">.:?</span> <span class="op">$</span>(configValue jiraField) <span class="op">&lt;|&gt;</span> <span class="fu">fmap</span> (<span class="fu">replicate</span> <span class="dv">1</span>) <span class="op">&lt;$&gt;</span> fields <span class="op">.:?</span> <span class="op">$</span>(configValue jiraField)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>     <span class="fu">pure</span> <span class="op">$</span> <span class="dt">ProjectCard</span> key projectName <span class="op">$</span> fromMaybe [] peopleMaybe</span></code></pre></div>
<p>Well, now I <a href="https://github.com/maksar/coorish/blob/35fbc99a57c57fae5a8232f9105ed81e6f61e06d/app/Jira.hs#L88-L94">know</a>, the trick is to make <code>FromJSON</code> instance for a function).</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">FromJSON</span> (<span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">ProjectCard</span>) <span class="kw">where</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  parseJSON <span class="ot">=</span> withObject <span class="st">&quot;card&quot;</span> <span class="op">$</span> \card <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    key <span class="ot">&lt;-</span> card <span class="op">.:</span> <span class="st">&quot;key&quot;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    fields <span class="ot">&lt;-</span> card <span class="op">.:</span> <span class="st">&quot;fields&quot;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    projectName <span class="ot">&lt;-</span> fields <span class="op">.:</span> <span class="st">&quot;summary&quot;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    allPossiblePeople <span class="ot">&lt;-</span> M.fromList <span class="op">&lt;$&gt;</span> <span class="fu">mapM</span> parser (HM.toList fields)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> <span class="op">$</span> \feild <span class="ot">-&gt;</span> <span class="dt">ProjectCard</span> key projectName <span class="op">$</span> fromMaybe [] <span class="op">$</span> join <span class="op">$</span> <span class="fu">lookup</span> feild allPossiblePeople</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="ot">parser ::</span> <span class="dt">FromJSON</span> a <span class="ot">=&gt;</span> (<span class="dt">Text</span>, <span class="dt">Value</span>) <span class="ot">-&gt;</span> <span class="dt">Parser</span> (<span class="dt">Text</span>, <span class="dt">Maybe</span> [a])</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>parser (x, field) <span class="ot">=</span> (x,) <span class="op">&lt;$&gt;</span> (parseJSON field <span class="op">&lt;|&gt;</span> <span class="fu">fmap</span> (<span class="fu">replicate</span> <span class="dv">1</span>) <span class="op">&lt;$&gt;</span> parseJSON field) <span class="op">&lt;|&gt;</span> <span class="fu">pure</span> (x, <span class="dt">Nothing</span>)</span></code></pre></div>
<p>That (and NIX <a href="https://github.com/maksar/coorish/blob/master/flake.nix#L23-L46">flakes</a> of course) allowed me to create several binaries for each JIRA field to test against (instead of configuring it with terminal flags or environment variables). Being tired of typing <code>T.pack</code> and <code>T.unpack</code>, I decided to give a <a href="https://github.com/kowainik/relude">relude</a> a try – a custom prelude, which is quite nice to use (but I haven’t yet tried <a href="https://hackage.haskell.org/package/rio">rio</a> or <a href="https://github.com/serokell/universum">universum</a>).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">configs</span> = {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;technical-cordinator&quot;</span> = p:</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">p</span> <span class="st">&quot;Technical Coordinator&quot;</span> <span class="st">&quot;Tech Coordinators&quot;</span><span class="kw">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;cto-office-representative&quot;</span> = p:</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">p</span> <span class="st">&quot;CTO Office Representative&quot;</span> <span class="st">&quot;CTO Office&quot;</span><span class="kw">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;project-manager&quot;</span> = p: p <span class="st">&quot;Project manager&quot;</span> <span class="st">&quot;Managers All&quot;</span><span class="kw">;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="er">}</span><span class="kw">;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="ex">basePackage</span> = haskellPackages.callCabal2nix <span class="st">&quot;coorish&quot;</span> ./. { }<span class="kw">;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="ex">package</span> = <span class="er">(</span><span class="ex">name:</span> field: groups:</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="ex">basePackage.overrideDerivation</span> <span class="er">(</span><span class="ex">drv:</span> {</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="ex">pname</span> = <span class="st">&quot;coorish-</span><span class="va">${name}</span><span class="st">&quot;</span><span class="kw">;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="ex">buildInputs</span> = drv.buildInputs or [ ] ++ [ pkgs.makeWrapper ]<span class="kw">;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">postInstall</span> = <span class="st">''</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mv</span> <span class="va">$out</span>/bin/coorish-console <span class="va">$out</span>/bin/coorish-<span class="va">${name}</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rm</span> <span class="va">$out</span>/bin/coorish-server</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>      <span class="ex">wrapProgram</span> <span class="va">$out</span>/bin/coorish-<span class="va">${name}</span> <span class="at">--set</span> COORISH_JIRA_FIELD <span class="st">&quot;</span><span class="va">${field}</span><span class="st">&quot;</span> <span class="at">--set</span> COORISH_LDAP_GROUPS <span class="st">&quot;</span><span class="va">${groups}</span><span class="st">&quot;</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">''</span><span class="kw">;</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="kw">));</span></span></code></pre></div>
<h2 id="server">Server</h2>
<p>But having only console utilities are not useful for other people. Sometimes non-technical personnel wants to know “what is wrong” with project cards. So I decided to split the code into three parts:</p>
<ul>
<li>Library code, which does all the heavy lifting, but free of any presentation logic</li>
<li>Console application to display results in terminal (nix will build multiple binaries per config value)</li>
<li>Web server which executes all queries to JIRA and AD in concurrently and serves result on a single page</li>
</ul>
<p>Since web server needs all configs at once, I am concatenating everything together into <code>flatConfig</code> variable to pass it into <code>coorish-server</code> wrapper.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">basePackage</span> = haskellPackages.callCabal2nix <span class="st">&quot;coorish&quot;</span> ./coorish { }<span class="kw">;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">basePackageConsole</span> = haskellPackages.callCabal2nix <span class="st">&quot;console&quot;</span> ./console { coorish = basePackage<span class="kw">;</span> <span class="er">}</span><span class="kw">;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">basePackageServer</span> = haskellPackages.callCabal2nix <span class="st">&quot;server&quot;</span> ./server { coorish = basePackage<span class="kw">;</span> <span class="er">}</span><span class="kw">;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ex">flatConfig</span> = <span class="er">(</span><span class="ex">builtins.concatStringsSep</span> <span class="st">&quot;;&quot;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">(</span><span class="ex">map</span> <span class="er">(</span><span class="ex">f:</span> f <span class="er">(</span><span class="ex">a:</span> b: <span class="st">&quot;</span><span class="va">${a}</span><span class="st">=</span><span class="va">${b}</span><span class="st">&quot;</span><span class="kw">))</span> <span class="kw">(</span><span class="ex">lib.attrValues</span> configs<span class="kw">)));</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="ex">server</span> = basePackageServer.overrideDerivation <span class="er">(</span><span class="ex">drv:</span> {</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">pname</span> = <span class="st">&quot;coorish-server&quot;</span><span class="kw">;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">buildInputs</span> = drv.buildInputs or [ ] ++ [ pkgs.makeWrapper ]<span class="kw">;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">postInstall</span> = <span class="st">''</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">wrapProgram</span> <span class="va">$out</span>/bin/coorish-server <span class="at">--set</span> COORISH_SERVER_CONFIG <span class="st">&quot;</span><span class="va">${flatConfig}</span><span class="st">&quot;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">''</span><span class="kw">;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="er">}</span><span class="kw">);</span></span></code></pre></div>
<h2 id="plans">Plans</h2>
<p>I am also experimenting with generating a haskell data structure (with template-haskell) with fields, which would correspond to a JIRA project card on compile time.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ot">createConstant ::</span> <span class="dt">Q</span> [<span class="dt">Dec</span>]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>createConstant <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  cardTypeName <span class="ot">&lt;-</span> newName <span class="st">&quot;ProjectCard&quot;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  cardConsName <span class="ot">&lt;-</span> newName <span class="st">&quot;ProjectCard&quot;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  declare cardTypeName cardConsName <span class="op">=&lt;&lt;</span> <span class="fu">mapM</span> process <span class="op">=&lt;&lt;</span> runIO fields</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="ot">    process ::</span> <span class="dt">JiraField</span> <span class="ot">-&gt;</span> <span class="dt">Q</span> <span class="dt">VarBangType</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    process jf <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>      jName <span class="ot">&lt;-</span> newName <span class="op">$</span> T.unpack <span class="op">$</span> T.replace <span class="st">&quot; &quot;</span> <span class="st">&quot;&quot;</span> <span class="op">$</span> T.toLower <span class="op">$</span> jiraFieldName jf</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>      jType <span class="ot">&lt;-</span> fromJust <span class="op">&lt;$&gt;</span> lookupTypeName (T.unpack <span class="op">$</span> T.replace <span class="st">&quot;Value&quot;</span> <span class="st">&quot;&quot;</span> <span class="op">$</span> T.replace <span class="st">&quot;Multiple &quot;</span> <span class="st">&quot;&quot;</span> <span class="op">$</span> T.replace <span class="st">&quot;Single &quot;</span> <span class="st">&quot;&quot;</span> <span class="op">$</span> T.pack <span class="op">$</span> <span class="fu">show</span> <span class="op">$</span> jiraFieldType jf)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pure</span> (jName, <span class="dt">Bang</span> <span class="dt">NoSourceUnpackedness</span> <span class="dt">NoSourceStrictness</span>, <span class="dt">AppT</span> <span class="dt">ListT</span> (<span class="dt">ConT</span> jType))</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="ot">    declare ::</span> <span class="dt">Name</span> <span class="ot">-&gt;</span> <span class="dt">Name</span> <span class="ot">-&gt;</span> [<span class="dt">VarBangType</span>] <span class="ot">-&gt;</span> <span class="dt">Q</span> [<span class="dt">Dec</span>]</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    declare cardTypeName cardConsName z <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pure</span> [<span class="dt">DataD</span> [] cardTypeName [] <span class="dt">Nothing</span> [<span class="dt">RecC</span> cardConsName z] [<span class="dt">DerivClause</span> <span class="dt">Nothing</span> [<span class="dt">ConT</span> '<span class="dt">'Show</span>, <span class="dt">ConT</span> '<span class="dt">'Generic</span>, <span class="dt">ConT</span> '<span class="dt">'FromJSON</span>]]]</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">FieldTypePlurality</span> <span class="ot">=</span> <span class="dt">IssueKey</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>                        <span class="op">|</span> <span class="dt">Single</span> <span class="dt">FieldTypeKind</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>                        <span class="op">|</span> <span class="dt">Multiple</span> <span class="dt">FieldTypeKind</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>                        <span class="op">|</span> <span class="dt">UnknownField</span> <span class="kw">deriving</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>                        (<span class="dt">Generic</span>, <span class="dt">FromJSON</span>, <span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">FieldTypeKind</span> <span class="ot">=</span> <span class="dt">UserValue</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>                   <span class="op">|</span> <span class="dt">GroupValue</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>                   <span class="op">|</span> <span class="dt">StringValue</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>                   <span class="op">|</span> <span class="dt">DateValue</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>                   <span class="op">|</span> <span class="dt">DateTimeValue</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>                   <span class="op">|</span> <span class="dt">OptionValue</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>                   <span class="op">|</span> <span class="dt">NumberValue</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>                   <span class="op">|</span> <span class="dt">AutocompleteValue</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>                   <span class="kw">deriving</span> (<span class="dt">Generic</span>, <span class="dt">FromJSON</span>, <span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">JiraField</span> <span class="ot">=</span> <span class="dt">JiraField</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  {<span class="ot"> jiraFieldId ::</span> <span class="dt">Text</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>  ,<span class="ot"> jiraFieldName ::</span> <span class="dt">Text</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  ,<span class="ot"> jiraFieldType ::</span> <span class="dt">FieldTypePlurality</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> (<span class="dt">Generic</span>, <span class="dt">Show</span>)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">FromJSON</span> <span class="dt">JiraField</span> <span class="kw">where</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>  parseJSON <span class="ot">=</span> withObject <span class="st">&quot;field&quot;</span> <span class="op">$</span> \field <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">id</span> <span class="ot">&lt;-</span> field <span class="op">.:</span> <span class="st">&quot;id&quot;</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    name <span class="ot">&lt;-</span> field <span class="op">.:</span> <span class="st">&quot;name&quot;</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    config <span class="ot">&lt;-</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>      <span class="kw">if</span> <span class="fu">id</span> <span class="op">==</span> <span class="st">&quot;issuekey&quot;</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>        <span class="kw">then</span> <span class="fu">pure</span> <span class="dt">IssueKey</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">else</span> parseSchema <span class="op">=&lt;&lt;</span> field <span class="op">.:?</span> <span class="st">&quot;schema&quot;</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> <span class="op">$</span> <span class="dt">JiraField</span> <span class="fu">id</span> name config</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>   <span class="kw">where</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a><span class="ot">    parseSchema ::</span> <span class="dt">Maybe</span> <span class="dt">Object</span> <span class="ot">-&gt;</span> <span class="dt">Parser</span> <span class="dt">FieldTypePlurality</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    parseSchema <span class="dt">Nothing</span> <span class="ot">=</span> <span class="fu">pure</span> <span class="dt">UnknownField</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    parseSchema (<span class="dt">Just</span> schema) <span class="ot">=</span> parseType schema <span class="op">=&lt;&lt;</span> schema <span class="op">.:</span> <span class="st">&quot;type&quot;</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a><span class="ot">    parseType ::</span> <span class="dt">Object</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Parser</span> <span class="dt">FieldTypePlurality</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>    parseType _ <span class="st">&quot;user&quot;</span> <span class="ot">=</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Single</span> <span class="dt">UserValue</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    parseType _ <span class="st">&quot;number&quot;</span> <span class="ot">=</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Single</span> <span class="dt">NumberValue</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    parseType _ <span class="st">&quot;date&quot;</span> <span class="ot">=</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Single</span> <span class="dt">DateValue</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>    parseType _ <span class="st">&quot;datetime&quot;</span> <span class="ot">=</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Single</span> <span class="dt">DateTimeValue</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    parseType _ <span class="st">&quot;option&quot;</span> <span class="ot">=</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Single</span> <span class="dt">OptionValue</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>    parseType _ <span class="st">&quot;string&quot;</span> <span class="ot">=</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Single</span> <span class="dt">StringValue</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    parseType schema <span class="st">&quot;array&quot;</span> <span class="ot">=</span> parseArray <span class="op">&lt;$&gt;</span> schema <span class="op">.:</span> <span class="st">&quot;items&quot;</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>    parseType schema <span class="st">&quot;any&quot;</span> <span class="ot">=</span> parseCustom <span class="op">&lt;$&gt;</span> schema <span class="op">.:</span> <span class="st">&quot;custom&quot;</span></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>    parseType _ _ <span class="ot">=</span> <span class="fu">pure</span> <span class="dt">UnknownField</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a><span class="ot">    parseArray ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">FieldTypePlurality</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>    parseArray <span class="st">&quot;user&quot;</span> <span class="ot">=</span> <span class="dt">Multiple</span> <span class="dt">UserValue</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>    parseArray <span class="st">&quot;group&quot;</span> <span class="ot">=</span> <span class="dt">Multiple</span> <span class="dt">GroupValue</span></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>    parseArray <span class="st">&quot;option&quot;</span> <span class="ot">=</span> <span class="dt">Multiple</span> <span class="dt">OptionValue</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>    parseArray <span class="st">&quot;string&quot;</span> <span class="ot">=</span> <span class="dt">Multiple</span> <span class="dt">StringValue</span></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>    parseArray _ <span class="ot">=</span> <span class="dt">UnknownField</span></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a><span class="ot">    parseCustom ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">FieldTypePlurality</span></span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>    parseCustom <span class="st">&quot;com.itransition.jira.plugin.customfields.jira-custom-fields:singlecomplete&quot;</span> <span class="ot">=</span> <span class="dt">Single</span> <span class="dt">AutocompleteValue</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>    parseCustom <span class="st">&quot;com.itransition.jira.plugin.customfields.jira-custom-fields:typeaheadfield&quot;</span> <span class="ot">=</span> <span class="dt">Multiple</span> <span class="dt">AutocompleteValue</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>    parseCustom _ <span class="ot">=</span> <span class="dt">UnknownField</span></span></code></pre></div>
<p>That would allow to express programs “around” project cards in “their” language and not hardcode field names or IDs into NIX build configs. But the experiment is far from end…</p>
  </section>
</article>

<div id="disqus_thread"></div>
<script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://https-maksar-github-io.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </main>

  <footer>
    <a type="application/rss+xml" href="../../rss.xml">RSS Feed</a>
    Site generated by
    <a href="http://jaspervdj.be/hakyll">Hakyll</a>
  </footer>
</body>
</html>