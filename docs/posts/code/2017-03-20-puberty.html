<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Shestakov Alex Blog - Как отрастить «внутреннюю бороду» через инвариантное тестирование</title>
  <link rel="stylesheet" href="../../css/default.css" />

  <script type="text/javascript" src="../../vendor/jquery/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="../../vendor/fresco/js/fresco.min.js"></script>
  <link rel="stylesheet" type="text/css" href="../../vendor/fresco/css/fresco.css" />

  <link rel="stylesheet" href="../../vendor/highlight/styles/atom-one-dark.min.css">
  <script src="../../vendor/highlight/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
</head>

<body>
  <header>
    <div class="logo">
      <a href="../../">Shestakov Alex</a>
    </div>
    <nav>
      &amp;<a href="../../languages/english.html">english</a> &amp;<a href="../../languages/russian.html">russian</a>
      @<a href="../../categories/WAT.html">WAT</a> @<a href="../../categories/code.html">code</a> @<a href="../../categories/projects.html">projects</a>
      <a href="../../about.html">About</a>
    </nav>
  </header>

  <main role="main">
    <h1>Как отрастить «внутреннюю бороду» через инвариантное тестирование</h1>
    <article>
  <span class="header">
    March 20, 2017 &amp;<a href="../../languages/russian.html">russian</a> @<a href="../../categories/code.html">code</a> #<a href="../../tags/elm.html">elm</a> #<a href="../../tags/QuickCheck.html">QuickCheck</a>
  </span>
  <section>
    <p>Современная разработка ПО не обходится без автоматических тестов. Сюда входят базовые Unit и Integration тесты, сложные Performance и Penetration тесты, а также множество других способов проверить программу ещё до отправки тестировщкам. Менеджеры давно перестали спорить о пользе автоматических тестов. Команды, практикующие автоматизацию тестирования, следующие методологиям TDD и BDD, быстрее поставляют работающие системы с меньшим количеством ошибок. Что делает их, в конечном счете, конкурентоспособными на перегретом рынке коммерческой разработки программных систем.</p>
<!--more-->
<p>Существуют такие предметные области, где главное – это качество и стабильность работы всей системы или отдельных ее частей. В таких случаях разработчики могут и должны применять более мощные и строгие инструменты и методы автоматических проверок кода. Отличными примерами таких методов верификации программ являются два ортогональных друг-другу подхода: мутационное тестирование (mutation testing) и инвариантное тестирование (property-based testing).</p>
<p><img src="../../images/puberty/explanation.png" class="center" /></p>
<p>Суть метода мутационного тестирования заключается в намеренном изменении кода программы всеми возможными способами и последующей верификации того, что запуск тестов на модифицированном коде привел к ошибке. Если изменение кода программы не привело к «падению» какого-либо unit или integration теста, то можно сделать вывод либо о том, что изменяемый участок кода вообще не используется, либо тесты не содержат примера, приводящего к задействованию этого участка кода. В обоих случаях нужно обратить внимание на всесторонность тестов либо качество кода.</p>
<p>Инвариантное тестирование действует иначе – код остается неизменным, меняются данные. Суть в генерации псевдослучайных данных, поступающих на вход программы и последующей проверке набора свойств (инвариантов) на результате. Пример самого простого инварианта – отсутствие исключительных ситуаций в процессе работы программы. То есть, программа отрабатывает без аварийного завершения, вне зависимости от того, что было подано на вход.</p>
<p>Получается, что изменениям подвергаются либо данные, поступающие на вход программы, либо сама структура программы. Оба способа являются достаточно сложными в применении, но очень мощными инструментами. Цель этой публикации – познакомиться с сущностью и особенностями property-based тестирования на примере создания Workflow-движка с использованием функционального языка программирования ELM.</p>
<h2 id="строгая-типизация-и-вывод-типов">Строгая типизация и вывод типов</h2>
<p>ELM относится к статически типизированным, функциональным языкам программирования – аргументы и возвращаемое значение функции в ELM всегда описываются конкретными типами данных. Более того, в ELM все функции являются «чистыми», то есть не содержат «побочных эффектов». На практике это означает, что программы на ELM легче верифицировать: вызов произвольной функции с одним и тем же набором аргументов всегда вернёт один и тот же результат, не внося изменений в общее состояние системы.</p>
<p>В той или иной степени, эти преимущества свойственны многим функциональным языкам. Но ничего не бывает бесплатно: от разработчиков требуется дисциплина и умение мыслить в «функциональном» стиле. Больше не выйдет вернуть из функции <code>null</code> там, где это удобно, не пройдут и трюки с явным приведением типов. Придётся уделять больше внимания моделированию состояний и процессов из предметной области, а также заботиться о том, чтобы недопустимые состояния модели нельзя было выразить в коде.</p>
<h2 id="постановка-задачи">Постановка задачи</h2>
<p>Хватит пустых слов, покажите мне код! Окей, окей. Мы рассмотрим пример довольно простого, но в то же время нетривиального, движка Workflow-ов из моей предыдущей статьи <a href="../../posts/code/2015-12-16-mutant.html">Keep calm and kill mutants</a>:</p>
<hr />
<ul>
<li>Each step has a <strong>threshold</strong> value.</li>
<li>To <strong>proceed</strong> to the next step, it is necessary to get <em>threshold</em> number of votes.</li>
<li>Power users can <strong>force skip</strong> one step.</li>
<li>Users with at least <em>vote</em> permission can <strong>reject</strong> current step (previous step restarts).</li>
<li><strong>Inactive</strong> users cannot <em>vote</em> or <em>reject</em>.</li>
<li>User can only vote <strong>once</strong> on the same step.</li>
</ul>
<hr />
<p><img src="../../images/puberty/animation.gif" class="center full" /></p>
<p>Чтобы исходный код было проще понять, я решил не изобретать велосипед и попытался перевести код на <a href="https://github.com/maksar/mentat/blob/master/version_6/workflow.rb">ruby</a> в <code>ELM</code> один-в-один. Конечно, результат значительно отличается от оригинала – синтаксис и подход совершенно иные. Но хочется верить, что это даст возможность апеллировать к более привычному императивному <code>ruby</code> при возникновении сложностей.</p>
<h2 id="типы-данных">Типы данных</h2>
<p>Итак, начнем с определения самого главного типа – <code>Workflow</code>. Это структура (record), состоящая из набора полей</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Workflow</span> <span class="op">=</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    { <span class="fu">stepsConfig</span> : <span class="dt">Array</span> <span class="dt">Int</span> <span class="co">-- массив целых чисел, содержащий количество</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                              <span class="co">-- необходимых голосов на каждом шаге</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">,</span> <span class="fu">currentStep</span> : <span class="dt">Int</span>       <span class="co">-- текущий номер шага, на котором находится данный workflow</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">,</span> <span class="fu">votes</span> : <span class="dt">Array</span> <span class="dt">Bucket</span>    <span class="co">-- массив множеств пользователей, иными словами список пользователей,</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>                              <span class="co">-- проголосовавших на каждом из шагов</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div>
<p>Похожим образом определим и «пользователя» (<code>User</code>). Обратите внимание, что <code>User</code> это полноценный тип, в отличие от <code>Workflow</code>, который по сути является именованной структурой данных. Первое упоминание <code>User</code> – это название типа, а второе – это имя конструктора типа. В большинстве случаев программисты осознанно делают их одинаковыми для удобства.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">User</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> <span class="dt">User</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        { <span class="fu">name</span> : <span class="dt">String</span>                  <span class="co">-- строковое имя пользователя, используется</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                                         <span class="co">-- для идентификации (пример все-таки учебный)</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="fu">active</span> : <span class="dt">Bool</span>                  <span class="co">-- флаг активности пользователя (помним,</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                                         <span class="co">-- что неактивные пользователи не могут принимать</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                                         <span class="co">-- участия в голосовании)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="fu">permissions</span> : <span class="dt">Array</span> <span class="dt">Permission</span> <span class="co">-- список (массив) прав пользователя, тип Permission</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                                         <span class="co">-- определен как type Permission = VOTE | FORCE | NONE</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        }</span></code></pre></div>
<h2 id="реализация">Реализация</h2>
<p>Далее рассмотрим один из возможных путей исполнения программы – получение одобрения от пользователя с расширенными правами на каком-либо шаге процесса. Работа начинается с вызова функции <code>approve</code> (для сравнения – ссылка на соответствующую <a href="https://github.com/maksar/mentat/blob/master/version_6/workflow.rb#L10-L17">ruby</a> реализацию). Функция принимает два аргумента: <code>User</code> и <code>Workflow</code> и всегда возвращает <code>Workflow</code>. Если пользователь не активен <code>not (User.active user)</code>, то результат работы – неизмененный <code>workflow</code>. Иначе происходит сопоставление с образцом (pattern matching) по результату вычисления выражения <code>User.permission workflow.currentStep user</code> – вызов функции <code>permission</code> из пакета <code>User</code> с аргументами <code>workflow.currentStep</code> и <code>user</code>. Выглядит странно, но помогает IDE, услужливо подсказывающее сигнатуру функции <code>permission</code>: <code>permission : Int -&gt; User -&gt; Permission</code>. Тип <code>Permission</code> является алгебраической суммой, и компилятор требует от нас явно определить что делать в каждом случае.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">approve</span> : <span class="dt">User</span> <span class="op">-&gt;</span> <span class="dt">Workflow</span> <span class="op">-&gt;</span> <span class="dt">Workflow</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">approve</span> <span class="fu">user</span> <span class="fu">workflow</span> <span class="op">=</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="fu">not</span> (<span class="dt">User</span><span class="op">.</span><span class="fu">active</span> <span class="fu">user</span>) <span class="cf">then</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">workflow</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="dt">User</span><span class="op">.</span><span class="fu">permission</span> <span class="fu">workflow</span><span class="op">.</span><span class="fu">currentStep</span> <span class="fu">user</span> <span class="cf">of</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">FORCE</span> <span class="op">-&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                <span class="fu">increment</span> <span class="fu">user</span> <span class="fu">workflow</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>            <span class="dt">VOTE</span> <span class="op">-&gt;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                <span class="fu">vote</span> <span class="fu">user</span> <span class="fu">workflow</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>            <span class="dt">NONE</span> <span class="op">-&gt;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">workflow</span></span></code></pre></div>
<p>Так как голосующий пользователь имеет расширенный набор прав, ход исполнения программы продолжится вызовом функции <code>increment</code>. Сигнатура у этой функции такая же, как и у <code>approve</code> – пользователь на первом месте, а <code>workflow</code> на втором. Выбор такого порядка следования аргументов не случаен. Дело в том, что в <code>ELM</code>, как и в других функциональных языках, широкое применение нашли <code>pipeline</code> операторы: <code>|&gt;</code> и <code>&lt;|</code>. С их помощью удобно выстраивать цепочки вызовов, когда возвращаемое значение одной функции передается в следующую. Итак, <code>increment</code>, используя вспомогательную функцию <code>step</code>, конструирует новый экземпляр <code>newWorkflow</code>, где номер шага увеличен на единицу. <code>newWorkflow</code>, в свою очередь, тоже копия <code>workflow</code>-а из аргументов функции, но с измененным полем <code>votes</code>.</p>
<p>В императивном языке мы бы могли просто обновить один из элементов этого массива. Однако в функциональных языках данные, как правило, неизменяемые (immutable) – поэтому нельзя просто так взять и добавить <img src="../../images/puberty/meme.png" /> голос в множество голосов шага. Нужно сконструировать новое множество на основании существующего, в котором добавлен новый элемент. Этим занимается конструкция <code>DictSet.insert user bucket</code>, которая и создает новое множество на основе существующего <code>bucket</code>, добавляя в него <code>user</code>. Примечательно, что создание нового экземпляра множества никак не приводит к изменению старого, массив <code>bucket</code>-ов тоже ничего не знает о созданной копии одного <code>bucket</code>-а. Так что приходится модифицировать и массив тоже. Делается это с помощью функции <code>update</code> из пакета <code>Array.Extra</code> с сигнатурой <code>update : Int -&gt; (a -&gt; a) -&gt; Array a -&gt; Array a﻿</code>. Индекс элемента, который подвергается изменению, передается первым параметром, сам массив передается последним, а между ними – функция изменения элемента. То есть такая функция, куда на вход поступит <code>bucket</code>, а то, что получится на выходе и будет вставлено в массив на его место. Возвращаемое значение, понятное дело, должно быть того же типа.</p>
<p>Конструкция <code>let - in</code> может быть слегка непривычна для понимания, но если посмотреть на нее как на: <em>допустим</em> <code>newWorkflow</code> определен как <code>{ workflow | votes = ...</code> - тогда весь <code>increment</code> можно выразить в терминах <code>newWorkflow</code> как <code>step Forward newWorkflow</code> То есть по сути это всего лишь синтаксический сахар, явное именование части выражения.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">increment</span> : <span class="dt">User</span> <span class="op">-&gt;</span> <span class="dt">Workflow</span> <span class="op">-&gt;</span> <span class="dt">Workflow</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">increment</span> <span class="fu">user</span> <span class="fu">workflow</span> <span class="op">=</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">newWorkflow</span> <span class="op">=</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>            { <span class="fu">workflow</span> <span class="op">|</span> <span class="fu">votes</span> <span class="op">=</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">update</span> <span class="fu">workflow</span><span class="op">.</span><span class="fu">currentStep</span> (\<span class="fu">bucket</span> <span class="op">-&gt;</span> <span class="fu">insert</span> <span class="fu">user</span> <span class="fu">bucket</span>) <span class="fu">workflow</span><span class="op">.</span><span class="fu">votes</span> }</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">in</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">step</span> <span class="dt">Forward</span> <span class="fu">newWorkflow</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Direction</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> <span class="dt">Forward</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">Backward</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="fu">step</span> : <span class="dt">Direction</span> <span class="op">-&gt;</span> <span class="dt">Workflow</span> <span class="op">-&gt;</span> <span class="dt">Workflow</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="fu">step</span> <span class="fu">direction</span> <span class="fu">workflow</span> <span class="op">=</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">count</span> <span class="op">=</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="fu">direction</span> <span class="cf">of</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>                <span class="dt">Forward</span> <span class="op">-&gt;</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">1</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>                <span class="dt">Backward</span> <span class="op">-&gt;</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>                    <span class="op">-</span><span class="dv">1</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">in</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        { <span class="fu">workflow</span> <span class="op">|</span> <span class="fu">currentStep</span> <span class="op">=</span> <span class="fu">workflow</span><span class="op">.</span><span class="fu">currentStep</span> <span class="op">+</span> <span class="fu">count</span> }</span></code></pre></div>
<p>Ух, прямо голова кругом пошла от всего этого… Но зато немного разобрались в синтаксисе <code>ELM</code> и сути работы <code>workfow</code>-а. Вникнуть в тестирование будет гораздо легче.</p>
<h2 id="традиционное-тестирование">Традиционное тестирование</h2>
<p>Структура теста повторяет сценарий на картинке в начале статьи: создается <code>workflow</code>, состоящий из трех шагов с порогами 3, 2 и 2 соответственно: <code>Workflow.init [ 3, 2, 2 ]</code>. Далее, оператор <code>|&gt;</code> берет результат выражения слева, то есть проинициализированный <code>workflow</code> и подставляет его последним аргументом в выражение справа. То есть получается: <code>approve (create "User 1" True [ VOTE ]) (Workflow.init [ 3, 2, 2 ])</code>, а это и есть вызов функции <code>approve</code> с двумя аргументами: пользователем и <code>workflow</code>-ом! Без использования pipe оператора <code>|&gt;</code> пришлось бы писать огромное выражение с просто неприличным количеством круглых скобок (привет, <code>lisp</code>). Логика самих проверок видна из их описательной части (строка после <code>test</code>). До финального голосования пользователем “User 9”, <code>workflow</code> не должен быть завершенным, становится он таким только после финального голосования.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traditionalTest</span> : <span class="dt">Test</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">traditionalTest</span> <span class="op">=</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">workflow</span> <span class="op">=</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>            [ <span class="dv">3</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span> ]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                <span class="op">|&gt;</span> <span class="dt">Workflow</span><span class="op">.</span><span class="fu">init</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>                <span class="op">|&gt;</span> <span class="fu">approve</span> (<span class="fu">create</span> <span class="st">&quot;User 1&quot;</span> <span class="dt">True</span> [ <span class="dt">VOTE</span> ])</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>                <span class="op">|&gt;</span> <span class="fu">approve</span> (<span class="fu">create</span> <span class="st">&quot;User 1&quot;</span> <span class="dt">True</span> [ <span class="dt">VOTE</span> ])</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>                <span class="op">|&gt;</span> <span class="fu">approve</span> (<span class="fu">create</span> <span class="st">&quot;User 2&quot;</span> <span class="dt">True</span> [ <span class="dt">VOTE</span> ])</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>                <span class="op">|&gt;</span> <span class="fu">approve</span> (<span class="fu">create</span> <span class="st">&quot;User 3&quot;</span> <span class="dt">False</span> [ <span class="dt">VOTE</span> ])</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>                <span class="op">|&gt;</span> <span class="fu">approve</span> (<span class="fu">create</span> <span class="st">&quot;User 4&quot;</span> <span class="dt">True</span> [ <span class="dt">VOTE</span> ])</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>                <span class="op">|&gt;</span> <span class="fu">approve</span> (<span class="fu">create</span> <span class="st">&quot;User 5&quot;</span> <span class="dt">True</span> [ <span class="dt">NONE</span><span class="op">,</span> <span class="dt">FORCE</span> ])</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>                <span class="op">|&gt;</span> <span class="fu">reject</span> (<span class="fu">create</span> <span class="st">&quot;User 6&quot;</span> <span class="dt">True</span> [ <span class="dt">NONE</span><span class="op">,</span> <span class="dt">NONE</span><span class="op">,</span> <span class="dt">VOTE</span> ])</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>                <span class="op">|&gt;</span> <span class="fu">approve</span> (<span class="fu">create</span> <span class="st">&quot;User 7&quot;</span> <span class="dt">True</span> [ <span class="dt">NONE</span><span class="op">,</span> <span class="dt">VOTE</span> ])</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>                <span class="op">|&gt;</span> <span class="fu">approve</span> (<span class="fu">create</span> <span class="st">&quot;User 8&quot;</span> <span class="dt">True</span> [ <span class="dt">NONE</span><span class="op">,</span> <span class="dt">VOTE</span> ])</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">finalUser</span> <span class="op">=</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">create</span> <span class="st">&quot;User 9&quot;</span> <span class="dt">True</span> [ <span class="dt">NONE</span><span class="op">,</span> <span class="dt">VOTE</span><span class="op">,</span> <span class="dt">FORCE</span> ]</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">in</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">describe</span> <span class="st">&quot;Real world workflow example&quot;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>            [ <span class="fu">test</span> <span class="st">&quot;Initially, workflow is not finished&quot;</span> <span class="op">&lt;|</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>              <span class="fu">equal</span> <span class="dt">False</span> (<span class="fu">finished</span> <span class="fu">workflow</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">,</span> <span class="fu">test</span> <span class="st">&quot;But after approve it becomes finished&quot;</span> <span class="op">&lt;|</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>              <span class="fu">equal</span> <span class="dt">True</span> (<span class="fu">finished</span> (<span class="fu">approve</span> <span class="fu">finalUser</span> <span class="fu">workflow</span>))</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>            ]</span></code></pre></div>
<p>Ну, пока что мы не увидели ничего нового – тест подчиняется стандартной структуре: <a href="http://wiki.c2.com/?ArrangeActAssert">arrange, act, assert</a>. Посмотрим, что сможет предложить property-based тестирование.</p>
<h2 id="property-based-тестирование">Property-based тестирование</h2>
<p>Для начала, нам нужно сформулировать несколько инвариантов относительно какого-нибудь <code>workflow</code>-а. Возьмем за основу первое что приходит в голову: номер шага на котором он находится (свойство <code>currentStep</code>) не должен быть больше количества шагов, какие бы действия пользователи ни совершали с ним. Для этого можно использовать длину массива из свойства <code>stepsConfig</code>. После, для симметрии, добавим еще требование о неотрицательности номера шага. Такой инвариант в коде можно записать так: <code>step &gt;= 0 &amp;&amp; step &lt;= (length initWorkflow.stepsConfig)</code>. Условие <code>&lt;=</code> на правой границе приемлемо, так как переходя в завершенное состояние <code>workflow</code> формально будет находиться на следующем за последним шагом. Осталось определить, что такое <code>step</code> и выразить в коде концепцию «что бы пользователи ни делали».</p>
<p>Для целей проверки <code>workflow</code>-а на «вшивость» по верхней границе можно чуть ослабить утверждение «что бы пользователи ни делали» до «сколько бы разные пользователи ни <code>approve</code>-али» – ведь <code>reject</code> неизбежно приводит к уменьшению номера шага, а <code>approve</code> только к увеличению. То есть если где-то взять список голосующих пользователей, то <code>step</code> можно выразить как <code>(foldl approve initWorkflow users).currentStep</code>. Согласен, выглядит подозрительно коротко. Кто-то уже представил в голове цикл, пробегающийся по пользователям и вызывающий на каждом шаге функцию голосования. Однако функциональная природа языка и аккуратный подход к дизайну методов все упрощают. <code>foldl</code> – это широко применяемая функция высшего порядка, которая производит операцию <a href="https://en.wikipedia.org/wiki/Fold_(higher-order_function)">свертки</a>. Ее три параметра это – функция преобразования <code>approve</code>, начальное значение <code>initWorkflow</code> и список, который требуется «свернуть» – <code>users</code>. Переводя на человеческий язык: начиная с <code>initialWorkflow</code>, последовательно вызвать функцию <code>approve</code> с аргументами из списка <code>users</code>, чтобы получился итоговый <code>workflow</code>. Еще раз стоит себя похвалить за правильный выбор порядка аргументов функции <code>approve</code>, пользователь передается первым параметром, как того требует контракт «свертки».</p>
<p>Теперь у нас есть всё для формулирования первого property-based теста. Обратите внимание как натурально читается DSL: утверждаю (<code>claim</code>) что гипотеза верна (<code>true</code>) для (<code>for</code>) набора случайных пользователей. Синтаксис <code>\(параметры) -&gt; выражение</code> (или <code>\параметр -&gt; выражение</code> в случае одного аргумента) не что иное, как объявление анонимной функции.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">claim</span> <span class="st">&quot;Workflow should remain in its bounds&quot;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="fu">true</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        (\<span class="fu">users</span> <span class="op">-&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>            <span class="fu">member</span> (<span class="fu">foldl</span> <span class="fu">approve</span> <span class="fu">initWorkflow</span> <span class="fu">users</span>)<span class="op">.</span><span class="fu">currentStep</span> <span class="op">&lt;|</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                <span class="fu">range</span> <span class="dv">0</span> (<span class="fu">length</span> <span class="fu">initWorkflow</span><span class="op">.</span><span class="fu">stepsConfig</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="fu">for</span> (<span class="fu">list</span> <span class="fu">userProducer</span>)</span></code></pre></div>
<p>Перед тем как углубиться в суть выражения <code>list userProducer</code>, стоит все же посмотреть на результаты запуска. Видно, что довольно быстро нашелся контрпример, опровергающий наш инвариант. Очень хотелось верить в код, написанный нами с такой аккуратностью и протестированный в предыдущей инкарнации mutation тестами, но он оказался не так уж и хорош. Глядя на контрпример, становится очевидно в чем проблема: если пользователь имеет <code>FORCE</code> привилегии, то код не делает никаких проверок и просто-напросто увеличивает номер шага!</p>
<pre class="console"><code>✗ Workflow should remain in its bounds

    On check 3, found counterexample:
      [User { name = &quot;&quot;, active = True, permissions = Array.fromList [VOTE] },
       User { name = &quot;&quot;, active = True, permissions = Array.fromList [NONE,FORCE] },
       User { name = &quot;&quot;, active = True, permissions = Array.fromList [NONE,NONE,FORCE] },
       User { name = &quot;&quot;, active = True, permissions = Array.fromList [NONE,NONE,NONE,FORCE] }]
    Expected:   True
    But It Was: False</code></pre>
<h2 id="генерация-случайных-данных">Генерация случайных данных</h2>
<p>Выражение <code>list userProducer</code> имеет тип <code>Producer (List User)</code>, что можно прочитать как «Генератор Списка Пользователей». Он получается применением комбинатора <code>list</code> (имеющего сигнатуру типа <code>list : Producer a -&gt; Producer (List a)</code>) к генератору <code>userProducer</code> (с типом <code>Producer User</code>). На основе одного генератора легко построить другой, более сложный. Так, между прочим, и был построен <code>userProducer</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">userProducer</span> : <span class="dt">Producer</span> <span class="dt">User</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">userProducer</span> <span class="op">=</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">convert</span> (<span class="fu">uncurry3</span> <span class="fu">create</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">toTuple</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        (<span class="fu">tuple3</span> ( <span class="fu">string</span><span class="op">,</span> <span class="fu">bool</span><span class="op">,</span> <span class="fu">list</span> <span class="fu">permissionProducer</span> ))</span></code></pre></div>
<p>Жонглирование кортежами (<code>tuple</code>) – всего лишь вынужденная машинерия. Главное тут то, что мы «объясняем» как сконструировать пользователя при помощи функции <code>create</code>, используя два примитивных генератора: <code>string</code> и <code>bool</code> а так же результат другой комбинации – <code>list permissionProducer</code>. Еще одной важной особенностью является так же «объяснение» как, зная пользователя, извлечь кортеж его трех составляющих. Для этого служит функция <code>toTuple</code>, которая получив пользователя на вход, возвращает кортеж из трех элементов.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">toTuple</span> : <span class="dt">User</span> <span class="op">-&gt;</span> ( <span class="dt">String</span><span class="op">,</span> <span class="dt">Bool</span><span class="op">,</span> <span class="dt">List</span> <span class="dt">Permission</span> )</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">toTuple</span> <span class="fu">user</span> <span class="op">=</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    ( (<span class="fu">name</span> <span class="fu">user</span>)<span class="op">,</span> (<span class="fu">active</span> <span class="fu">user</span>)<span class="op">,</span> (<span class="fu">permissions</span> <span class="fu">user</span>) )</span></code></pre></div>
<p>Именно «знание» о том, как «разобрать» пользователя на примитивы и помогло найти ошибки в коде так быстро. Имена и количество пользователей, набор привилегий каждого из них и все остальные аспекты контрпримера выглядят «минимальными»: пустое имя пользователя, отсутствие других пользователей в списке кроме действительно необходимых и т.п. Код библиотеки тестирования упрощал каждый аспект начального контрпримера до тех пор, пока это было возможным, разбивая каждый из <code>Producer</code>-ов на составные части, упрощая их и собирая обратно.</p>
<h2 id="исправление-кода">Исправление кода</h2>
<p>Перепишем функцию <code>approve</code> так, чтобы избавиться от ошибки. Теперь проверке подвергается не только флаг неактивности пользователя, но и завершенность <code>workflow</code>-а, а так же факт того, голосовал ли пользователь на текущем шаге.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">approve</span> : <span class="dt">User</span> <span class="op">-&gt;</span> <span class="dt">Workflow</span> <span class="op">-&gt;</span> <span class="dt">Workflow</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">approve</span> <span class="fu">user</span> <span class="fu">workflow</span> <span class="op">=</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="fu">locked</span> <span class="fu">user</span> <span class="fu">workflow</span> <span class="cf">then</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">workflow</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="dt">User</span><span class="op">.</span><span class="fu">permission</span> <span class="fu">workflow</span><span class="op">.</span><span class="fu">currentStep</span> <span class="fu">user</span> <span class="cf">of</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">FORCE</span> <span class="op">-&gt;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                <span class="fu">increment</span> <span class="fu">user</span> <span class="fu">workflow</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>            <span class="dt">VOTE</span> <span class="op">-&gt;</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>                <span class="fu">vote</span> <span class="fu">user</span> <span class="fu">workflow</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>            <span class="dt">NONE</span> <span class="op">-&gt;</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">workflow</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="fu">locked</span> : <span class="dt">User</span> <span class="op">-&gt;</span> <span class="dt">Workflow</span> <span class="op">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="fu">locked</span> <span class="fu">user</span> <span class="fu">workflow</span> <span class="op">=</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">currentBucket</span> <span class="op">=</span> <span class="fu">currentStepVotes</span> <span class="fu">workflow</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">in</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">any</span> <span class="fu">identity</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>            [ <span class="fu">finished</span> <span class="fu">workflow</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>            <span class="op">,</span> <span class="dt">User</span><span class="op">.</span><span class="fu">inactive</span> <span class="fu">user</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">,</span> <span class="fu">member</span> <span class="fu">user</span> <span class="fu">currentBucket</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>            ]</span></code></pre></div>
<p>С таким исправлением реализации запуск тестов завершается успешно, никаких ошибок больше нет. Постараемся сформулировать еще инварианты для проверки. Последний пункт требований к <code>workflow</code> гласит, что пользователь должен иметь возможность голосовать только один раз на каждом из шагов – выразим это в коде. В этот раз используем другую синтаксическую конструкцию: «<code>claim</code> описание <code>that</code> выражение <code>is</code> эквивалент <code>for</code> генератор». То есть для каждой пары пользователь-операция код пытается применить эту операцию к <code>workflow</code>-у, на текущем шаге которого пользователь с таким же именем уже голосовал. Инвариант заключается в том, что шаг <code>workflow</code>-а измениться при этом не должен.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">workflowVotedByUser</span> : <span class="dt">User</span> <span class="op">-&gt;</span> <span class="dt">Workflow</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">workflowVotedByUser</span> <span class="fu">user</span> <span class="op">=</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">userWithSameName</span> <span class="op">=</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>            <span class="fu">create</span> (<span class="fu">name</span> <span class="fu">user</span>) <span class="dt">True</span> [ <span class="dt">VOTE</span><span class="op">,</span> <span class="dt">VOTE</span> ]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">in</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">initWorkflow</span> <span class="op">|&gt;</span> <span class="fu">twice</span> (<span class="fu">approve</span> <span class="fu">userWithSameName</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="fu">claim</span> <span class="st">&quot;Same user cannot vote twice&quot;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="fu">that</span> (\( <span class="fu">user</span><span class="op">,</span> <span class="fu">operation</span> ) <span class="op">-&gt;</span> (<span class="fu">workflowVotedByUser</span> <span class="fu">user</span> <span class="op">|&gt;</span> <span class="fu">apply</span> <span class="fu">operation</span> <span class="fu">user</span>)<span class="op">.</span><span class="fu">currentStep</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="fu">is</span> (\( <span class="fu">user</span><span class="op">,</span> <span class="fu">operation</span> ) <span class="op">-&gt;</span> (<span class="fu">workflowVotedByUser</span> <span class="fu">user</span>)<span class="op">.</span><span class="fu">currentStep</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">|&gt;</span> <span class="fu">for</span> (<span class="fu">tuple</span> ( <span class="fu">userProducer</span><span class="op">,</span> <span class="fu">operationProducer</span> ))</span></code></pre></div>
<p>Запуск тестов показывает, что инвариант нарушен: найдена такая пара пользователь-операция, при применении которой шаг <code>workflow</code>-а уменьшается на единицу.</p>
<pre class="console"><code>✗ Same user cannot vote twice

    On check 1, found counterexample:
      (User { name = &quot;&quot;, active = False, permissions = Array.fromList [NONE,VOTE] },Reject)
    Expected:   1
    But It Was: 0</code></pre>
<p>И действительно, в функцию <code>reject</code> так же закралась ошибка. Применение <code>locked</code> вместо <code>not User.active</code> исправляет ситуацию – все тесты теперь зеленые.</p>
<pre class="console"><code>Running 4 tests. To reproduce these results, run: elm-test --seed 2042167370

TEST RUN PASSED

Duration: 5 ms
Passed:   4
Failed:   0</code></pre>
<h2 id="заключение">Заключение</h2>
<p>При помощи всего двух простых инвариантов удалось обнаружить несколько нетривиальных проблем в реализации <code>workflow</code>-а. Найти их традиционными способами трудно – разработчик, может, и проверит, получится ли голосовать второй раз на одном и том же шаге, однако вряд ли он попытается сделать <code>reject</code> сразу после голосования в коде unit тестов. К слову, в <code>ruby</code> реализации, вдоль и поперек проверенной мутационным тестированием, обнаружились эти же дефекты ;) Что в очередной раз доказывает, что «серебряной пули» не существует и полагаться только на один способ проверки – наивно.</p>
<p>Библиотеки для property-based тестирования существуют не только для полностью функциональных языков программирования: в <code>ruby</code> это <a href="https://github.com/abargnesi/rantly">rantly</a>, в <code>python</code> – <a href="https://github.com/HypothesisWorks/hypothesis-python">hypothesis</a>, в <code>Java</code> – <a href="https://github.com/pholser/junit-quickcheck">junit-quickcheck</a> и т.д.</p>
<p>Главным препятствием к использованию property-based тестов я вижу отнюдь не сложность формулирования инвариантов (хотя это действительно непросто) и даже не отсутствие развитого инструментария в некоторых языках программирования, а именно недостаточную осведомленность разработчиков. Надеюсь, примером с <code>workflow</code>-ом у меня вышло пробудить заинтересованность и обратить внимание на тему инвариантного тестирования.</p>
<p>Исходный код на языке <code>ELM</code> можно отыскать в публичном <a href="https://github.com/maksar/elm-workflow">репозитории</a>.</p>
  </section>
</article>

  </main>

  <footer>
    <a type="application/rss+xml" href="../../rss.xml">RSS Feed</a>
    Site generated by
    <a href="http://jaspervdj.be/hakyll">Hakyll</a>
  </footer>
</body>
</html>