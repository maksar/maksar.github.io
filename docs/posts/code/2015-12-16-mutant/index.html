<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Shestakov Alex Blog Keep calm and kill mutants</title>
  <link rel="stylesheet" href="../../../css/default.css" />

  <script type="text/javascript" src="../../../vendor/jquery/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="../../../vendor/fresco/js/fresco.min.js"></script>
  <link rel="stylesheet" type="text/css" href="../../../vendor/fresco/css/fresco.css" />

  <link rel="stylesheet" href="../../../vendor/highlight/styles/atom-one-dark.min.css">
  <script src="../../../vendor/highlight/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon"><link rel="shortcut icon" href="../../../images/favicons/favicon32.png"><link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../../images/favicons/favicon144.png"><link rel="apple-touch-icon-precomposed" sizes="114x114" href="../../../images/favicons/favicon114.png"><link rel="apple-touch-icon-precomposed" sizes="72x72" href="../../../images/favicons/favicon72.png"><link rel="apple-touch-icon-precomposed" sizes="57x57" href="../../../images/favicons/favicon57.png">
</head>

<body>
  <header>
    <div class="logo">
      <a href="../../../">Shestakov Alex</a>
    </div>
    <nav>
      &amp;<a href="../../../languages/english">english</a> &amp;<a href="../../../languages/russian">russian</a>
      @<a href="../../../categories/WAT">WAT</a> @<a href="../../../categories/code">code</a> @<a href="../../../categories/projects">projects</a>
      <a href="../../../about">About</a>
    </nav>
  </header>

  <main role="main">
    <h1>Keep calm and kill mutants</h1>
    
<article>
  <span class="header">
    
      December 16, 2015 &amp;<a href="../../../languages/english">english</a> @<a href="../../../categories/code">code</a> #<a href="../../../tags/ruby">ruby</a>
  </span>
  <section>
    <p>Mutants, zombies… Yes, there is an inconsistency between the article’s topic and image to attract attention. But I swear to god it is actually the poster hanging on the wall inside my flat.</p>
<p>The topic of this article is mutation testing – a very special methodology among others in the field of testing software quality. It is capable to amaze, make you think you lost your mind and, finally, can bring peace into your programmer’s soul. I know, the definition sounds quite bold and pretentious, but I hope that after reading the rest of the article you’ll be convinced just like I am.</p>
<!--more-->
<p><img src="../../../previews/mutant/logo.png" class="center" /></p>
<p><a href="https://en.wikipedia.org/wiki/Mutation_testing">Mutation testing</a> technique is based on quite a simple idea. Say, you have a bunch of code and a number of tests to verify its correctness. Doesn’t matter how those tests were born: using techniques like <a href="https://en.wikipedia.org/wiki/Test-driven_development">TDD</a> or written afterwards. Mutation testing allows to verify that your test suite is <strong>full</strong>. By <strong>full</strong> I mean – there is no code (code execution path, to be precisely correct) that is not covered with at least one test case.</p>
<h2 id="program-correctness">Program Correctness</h2>
<p>Why do we have to measure test coverage after all? To be sure that the program behaves as intended, to protect from regression failures, etc. How about program <a href="https://en.wikipedia.org/wiki/Correctness_(computer_science)">correctness</a>? How do we get confidence that the program works correctly on all valid inputs? Well, it’s hard to cover all program states (for some programs is’t not possible at all). Consider function <code>next_char</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> next_char(char)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  char<span class="at">.ord.next.chr</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>A quite simple function accepting a character and returning the next one in <a href="https://en.wikipedia.org/wiki/ASCII">ASCII</a> table. To prove it’s correct, it would be needed to pass every possible char out there, including the edge case for <code>"\xFF"</code>.</p>
<p>A light change to <code>next_char</code> (now it accepts the optional <code>step</code> parameter to specify <em>how far to jump</em>) function makes testing impossible:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> next_char(char, step <span class="kw">=</span> <span class="dv">1</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  (char<span class="at">.ord</span> <span class="kw">+</span> step)<span class="at">.chr</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>To fully cover all input parameter space, we would need to pass every possible integer value for each possible char… So, I think it’s clear now why program correctness will always remain in the field of computer science. However, there are other kinds of metrics, letting you gain confidence that your code is actually correct.</p>
<h2 id="coverage">Coverage</h2>
<p>There are test coverage tools out there for almost every language. Yes, but most of them collect statistics only about source code lines, namely, whether particular line of source code was executed or not (and how many times). But in fact, there is more than just line coverage: just look at this <a href="http://www.slideshare.net/hiroppie/test-coverage">slide</a>.</p>
<p><strong>C1</strong> is intended to track code branches execution. Each source code line can potentially contain more than one code branch. Think about conditions, loops, early returns and nasty things like <code>try</code> operator. To satisfy <strong>C1</strong> coverage, tests should contain at least two cases, one for each of the execution branch. Otherwise, some branches may remain <em>un-visited</em> having, however, <strong>C0</strong> coverage on this particular line satisfied.</p>
<p><strong>C2</strong> is called condition coverage. If condition expression consists of more than one sub-expressions (for example: <code>if a == 2 || b.nil?</code>), it ensures that each sub-expression gets evaluated to <code>true</code> and <code>false</code> at least once.</p>
<h2 id="a-real-world-example">A real world example</h2>
<p>Enough with theory, as programmers we love to get our hands dirty and see some code. Let’s write an example program to automate a simple workflow business process:</p>
<p>Workflow consists of many steps, each of which is configured with a threshold value. To proceed to the next step of the workflow, it’s necessary to get the number of votes from applicable (according to the voting permissions) users. If a user has enough permissions, it’s possible for him to force skip one workflow step. Every user with at least a voting permission can reject the current step of the voting process. Workflow will continue from the beginning of previous step. Inactive users cannot vote or reject. A user can only vote once on the same step.</p>
<p><img src="../../../images/mutant/animation.gif" class="center full" /></p>
<p>Here is one possible implementation of the described workflow:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">class</span> <span class="dt">Workflow</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> initialize(steps_config)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@steps_config</span> <span class="kw">=</span> steps_config</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@current_step</span> <span class="kw">=</span> <span class="dv">0</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@votes</span> <span class="kw">=</span> <span class="dt">Array</span><span class="at">.new</span>(steps_config<span class="at">.size</span>) <span class="kw">{</span> <span class="dt">Set</span><span class="at">.new</span> <span class="kw">}</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> approve(actor)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cf">unless</span> actor<span class="at">.active?</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> actor<span class="at">.can_force_step?</span>(<span class="ot">@current_step</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>      increment</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elsif</span> actor<span class="at">.can_vote_on_step?</span>(<span class="ot">@current_step</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>      vote(actor)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> reject(actor)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cf">unless</span> actor<span class="at">.active?</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    decrement <span class="cf">if</span> actor<span class="at">.can_vote_on_step?</span>(<span class="ot">@current_step</span>) <span class="kw">||</span> actor<span class="at">.can_force_step?</span>(<span class="ot">@current_step</span>)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> finished?</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@current_step</span> <span class="kw">==</span> <span class="ot">@steps_config</span><span class="at">.size</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">private</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> increment</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@current_step</span> <span class="kw">+=</span> <span class="dv">1</span> <span class="cf">unless</span> finished?</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> vote(actor)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@votes</span><span class="kw">[</span><span class="ot">@current_step</span><span class="kw">]</span> <span class="kw">&lt;&lt;</span> actor</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    increment <span class="cf">if</span> <span class="ot">@votes</span><span class="kw">[</span><span class="ot">@current_step</span><span class="kw">]</span><span class="at">.size</span> <span class="kw">&gt;=</span> <span class="ot">@steps_config</span><span class="kw">[</span><span class="ot">@current_step</span><span class="kw">]</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">def</span> decrement</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@votes</span><span class="kw">[</span><span class="ot">@current_step</span><span class="kw">]</span> <span class="kw">=</span> <span class="dt">Set</span><span class="at">.new</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@current_step</span> <span class="kw">-=</span> <span class="dv">1</span> <span class="cf">unless</span> <span class="ot">@current_step</span> <span class="kw">==</span> <span class="dv">0</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    <span class="ot">@votes</span><span class="kw">[</span><span class="ot">@current_step</span><span class="kw">]</span> <span class="kw">=</span> <span class="dt">Set</span><span class="at">.new</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>It was written without any tests in mind, but looks… robust. All required business features are there: inactive users, duplicate votes, force approves, etc. So, let’s tests it! It would be a good idea to actually bring the example from the diagram to existence.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>describe <span class="dt">Workflow</span> <span class="cf">do</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  subject <span class="kw">{</span> <span class="dt">Workflow</span><span class="at">.new</span>(<span class="kw">[</span><span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">2</span><span class="kw">]</span>) <span class="kw">}</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  it <span class="vs">'works in real world scenario'</span> <span class="cf">do</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    subject<span class="at">.approve</span>(voter <span class="kw">=</span> <span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span><span class="kw">]</span>)) <span class="co"># First vote on first step</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    subject<span class="at">.approve</span>(voter) <span class="co"># Subsequent vote does not affect workflow state</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span><span class="kw">]</span>)) <span class="co"># Second vote on first workflow step</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span><span class="kw">]</span>, <span class="dv">false</span>)) <span class="co"># Inactive users cannot affect workflow state</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span><span class="kw">]</span>)) <span class="co"># Final vote, workflow proceeds to the next step</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">NONE</span>, <span class="cn">FORCE</span><span class="kw">]</span>)) <span class="co"># Workflow is forced to proceed to the third step</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    subject<span class="at">.reject</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">NONE</span>, <span class="cn">NONE</span>, <span class="cn">VOTE</span><span class="kw">]</span>)) <span class="co"># Reject! Falling back to the second step and starting over</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">NONE</span>, <span class="cn">VOTE</span><span class="kw">]</span>)) <span class="co"># Getting first</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">NONE</span>, <span class="cn">VOTE</span><span class="kw">]</span>)) <span class="co"># And second vote on second step</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    expect <span class="cf">do</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>      subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">NONE</span>, <span class="cn">VOTE</span>, <span class="cn">FORCE</span><span class="kw">]</span>)) <span class="co"># Completing workflow by skipping voting process on last step</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span><span class="at">.to</span> change <span class="kw">{</span> subject<span class="at">.finished?</span> <span class="kw">}</span><span class="at">.from</span>(<span class="dv">false</span>)<span class="at">.to</span>(<span class="dv">true</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>Running spec is successful indeed. Moreover, <code>simplecov</code> claims to have <strong>100%</strong> code coverage!</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>➜  mentat git<span class="op">:(</span>master<span class="op">)</span> rspec version_1<span class="op">/</span>workflow_spec<span class="op">.</span><span class="fu">rb</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>Workflow</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  works in real world scenario</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>Finished in <span class="fl">0.00181</span> <span class="fu">seconds</span> <span class="op">(</span>files took <span class="fl">0.13433</span> seconds to load<span class="op">)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> example<span class="op">,</span> <span class="dv">0</span> failures</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>Coverage report generated <span class="cf">for</span> RSpec to <span class="op">/</span>Users<span class="op">/</span>maksar<span class="op">/</span>projects<span class="op">/</span>mentat<span class="op">/</span>coverage<span class="op">.</span> <span class="dv">40</span> <span class="op">/</span> <span class="dv">40</span> <span class="fu">LOC</span> <span class="op">(</span><span class="fl">100.0</span><span class="op">%)</span> covered<span class="op">.</span></span></code></pre></div>
<p><img src="../../../images/mutant/coverage.png" class="center full" /></p>
<h2 id="mutation-testing">Mutation testing</h2>
<p>This is where the story might end for a mediocre developer. One would think that since coverage indicates we are good, there is no work left to do. Well, let’s not be in a hurry, <a href="https://github.com/mbj/mutant">mutant</a> to the rescue!</p>
<pre class="console"><code>$ mentat git:(master) mutant -I . -r version_1/workflow_spec.rb --use rspec 'Workflow'</code></pre>
<p><a href="https://asciinema.org/a/31217" target="_blank"><img src="https://asciinema.org/a/31217.svg" class="center full" /></a></p>
<p>What? Only <strong>64.71%</strong>? It sounds very… sobering. Let’s see what just happened. We specified mutation target (<code>'Workflow'</code> string in the command line), mutant detected 7 mutation subjects (methods) in that class. For each subject, it has constructed an <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a> (Abstract Syntax Tree) of the code and tried to apply different <em>mutations</em> to it. Mutations are small code changes, for example: flipping a condition to its opposite, removing a whole line of code, changing constant value, etc. Mutations are easier to deal with working with AST instead of plain text, and that’s why mutant parses your code, applies mutation (new Mutant is born) and then converts AST back to code and inserts it into your VM, to let <code>rspec</code> execute tests against it (attempt to kill the Mutant). If all tests are passed, Mutant remains alive. Think about it: someone just deleted a whole line from your code, and tests are still passing… That basically means that a test suite does not contain enough examples to cover all execution branches.</p>
<p>On the screenshot above, mutant claims that if we remove condition check inside <code>vote</code> method, tests will continue to work. Hard to believe? Let’s verify:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> vote(actor)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@votes</span><span class="kw">[</span><span class="ot">@current_step</span><span class="kw">]</span> <span class="kw">&lt;&lt;</span> actor</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  increment</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>Code is changed, running specs:</p>
<pre class="console"><code>$ mentat git:(master) rspec version_1/workflow_spec.rb -f p
.

Finished in 0.00144 seconds (files took 0.08017 seconds to load)
1 example, 0 failures</code></pre>
<p>Zero failures! It surprises me every time… After staring at other alive Mutants I finally realized how stupid I was, thinking that one test case proves correctness or can protect me from regressions. OK, enough being dumb, we can do better! This time I tried to write a very extensive test suite, covering every business feature one by one:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>describe <span class="dt">Workflow</span> <span class="cf">do</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  context <span class="vs">'empty workflow'</span> <span class="cf">do</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    subject <span class="kw">{</span> <span class="dt">Workflow</span><span class="at">.new</span>(<span class="kw">[]</span>) <span class="kw">}</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    it(<span class="vs">'should be already finished'</span>) <span class="kw">{</span> expect(subject)<span class="at">.to</span> be_finished <span class="kw">}</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="cn">ALL</span><span class="at">.each</span> <span class="cf">do</span> <span class="kw">|</span>permission<span class="kw">|</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>      it(<span class="st">&quot;should remain finished after </span><span class="sc">#{</span>permission<span class="sc">}</span><span class="st"> reject action&quot;</span>) <span class="cf">do</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        expect <span class="kw">{</span> subject<span class="at">.reject</span>(<span class="dt">User</span><span class="at">.new</span>(permission)) <span class="kw">}</span><span class="at">.not_to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>      it(<span class="st">&quot;should remain finished after </span><span class="sc">#{</span>permission<span class="sc">}</span><span class="st"> approve action&quot;</span>) <span class="cf">do</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        expect <span class="kw">{</span> subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(permission)) <span class="kw">}</span><span class="at">.not_to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  context <span class="vs">'workflow from single step'</span> <span class="cf">do</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">[</span><span class="dv">0</span>, <span class="dv">1</span><span class="kw">]</span><span class="at">.each</span> <span class="cf">do</span> <span class="kw">|</span>votes<span class="kw">|</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>      context <span class="st">&quot;where step requires </span><span class="sc">#{</span>votes<span class="sc">}</span><span class="st"> votes&quot;</span> <span class="cf">do</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        subject <span class="kw">{</span> <span class="dt">Workflow</span><span class="at">.new</span>(<span class="kw">[</span>votes<span class="kw">]</span>) <span class="kw">}</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        it(<span class="vs">'should not be initially finished'</span>) <span class="kw">{</span> expect(subject)<span class="at">.not_to</span> be_finished <span class="kw">}</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        it(<span class="vs">'should not be finished after approve from incapable actor'</span>) <span class="cf">do</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>          expect <span class="kw">{</span> subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">NONE</span><span class="kw">]</span>)) <span class="kw">}</span><span class="at">.not_to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        <span class="cn">ACTIONABLE</span><span class="at">.each</span> <span class="cf">do</span> <span class="kw">|</span>permission<span class="kw">|</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>          it(<span class="st">&quot;should be finished after </span><span class="sc">#{</span>permission<span class="sc">}</span><span class="st"> approve action&quot;</span>) <span class="cf">do</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>            expect <span class="kw">{</span> subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span>permission<span class="kw">]</span>)) <span class="kw">}</span><span class="at">.to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>          <span class="cf">end</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>          it(<span class="st">&quot;should not be finished after inactive actors </span><span class="sc">#{</span>permission<span class="sc">}</span><span class="st"> actions&quot;</span>) <span class="cf">do</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>            expect <span class="kw">{</span> subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span>permission<span class="kw">]</span>, <span class="dv">false</span>)) <span class="kw">}</span><span class="at">.not_to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>          <span class="cf">end</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    context <span class="vs">'where step requires two votes'</span> <span class="cf">do</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>      subject <span class="kw">{</span> <span class="dt">Workflow</span><span class="at">.new</span>(<span class="kw">[</span><span class="dv">2</span><span class="kw">]</span>) <span class="kw">}</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>      it(<span class="vs">'should be finished only after first force action'</span>) <span class="cf">do</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>        expect <span class="kw">{</span> subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">FORCE</span><span class="kw">]</span>)) <span class="kw">}</span><span class="at">.to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>      it(<span class="vs">'should be finished only after second vote action'</span>) <span class="cf">do</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>        expect <span class="kw">{</span> subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span><span class="kw">]</span>)) <span class="kw">}</span><span class="at">.not_to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        expect <span class="kw">{</span> subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span><span class="kw">]</span>)) <span class="kw">}</span><span class="at">.to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>      it(<span class="vs">'should not be finished after subsequent vote action of the same actor'</span>) <span class="cf">do</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>        subject<span class="at">.approve</span>(actor <span class="kw">=</span> <span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span><span class="kw">]</span>))</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>        expect <span class="kw">{</span> subject<span class="at">.approve</span>(actor) <span class="kw">}</span><span class="at">.not_to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>      <span class="cn">ACTIONABLE</span><span class="at">.each</span> <span class="cf">do</span> <span class="kw">|</span>permission<span class="kw">|</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>        it(<span class="st">&quot;should be able to reset votes by reject action from </span><span class="sc">#{</span>permission<span class="sc">}</span><span class="st"> actor&quot;</span>) <span class="cf">do</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>          subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span><span class="kw">]</span>))</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>          subject<span class="at">.reject</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span>permission<span class="kw">]</span>))</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>          expect <span class="kw">{</span> subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span><span class="kw">]</span>)) <span class="kw">}</span><span class="at">.not_to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>          expect <span class="kw">{</span> subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span><span class="kw">]</span>)) <span class="kw">}</span><span class="at">.to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>        it(<span class="st">&quot;inactive </span><span class="sc">#{</span>permission<span class="sc">}</span><span class="st"> actor cannot affect voting process&quot;</span>) <span class="cf">do</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>          subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span><span class="kw">]</span>))</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>          subject<span class="at">.reject</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span>permission<span class="kw">]</span>, <span class="dv">false</span>))</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>          expect <span class="kw">{</span> subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span><span class="kw">]</span>)) <span class="kw">}</span><span class="at">.to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>        it(<span class="vs">'actor without permissions cannot reject'</span>) <span class="cf">do</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>          subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span><span class="kw">]</span>))</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>          subject<span class="at">.reject</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">NONE</span><span class="kw">]</span>))</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>          expect <span class="kw">{</span> subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span><span class="kw">]</span>)) <span class="kw">}</span><span class="at">.to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>  context <span class="vs">'Workflow from three steps'</span> <span class="cf">do</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>    subject <span class="kw">{</span> <span class="dt">Workflow</span><span class="at">.new</span>(<span class="kw">[</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span><span class="kw">]</span>) <span class="kw">}</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>    it(<span class="vs">'reject should erase votes from current and previous step'</span>) <span class="cf">do</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>      subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">FORCE</span><span class="kw">]</span>))</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>      subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span>, <span class="cn">VOTE</span><span class="kw">]</span>))</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>      subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span>, <span class="cn">VOTE</span><span class="kw">]</span>))</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>      subject<span class="at">.reject</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span>, <span class="cn">VOTE</span>, <span class="cn">VOTE</span><span class="kw">]</span>))</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>      expect <span class="kw">{</span> subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">FORCE</span>, <span class="cn">FORCE</span>, <span class="cn">FORCE</span><span class="kw">]</span>)) <span class="kw">}</span><span class="at">.not_to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>      expect <span class="kw">{</span> subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">FORCE</span>, <span class="cn">FORCE</span>, <span class="cn">FORCE</span><span class="kw">]</span>)) <span class="kw">}</span><span class="at">.to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>Let’s run our <del>enemy</del>friend mutant once again:</p>
<p><a href="https://asciinema.org/a/31226" target="_blank"><img src="https://asciinema.org/a/31226.svg" class="center full" /></a></p>
<p>Much better this time, <strong>91.33%</strong> But not perfect, let’s see why:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a> def vote(actor)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="st">-  @votes[@current_step] &lt;&lt; actor</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="va">+  @votes.fetch(@current_step) &lt;&lt; actor</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>   if (@votes[@current_step].size &gt;= @steps_config[@current_step])</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>     increment</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>   end</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a> end</span></code></pre></div>
<p>This time, one of the mutant’s complains was about using <code>.fetch</code> method instead of just <code>[]</code> array accessor. You might think it’s not a big of a deal, but it’s worth thinking deeper. The difference between the semantics of <code>[]</code> and <code>fetch</code> is in absent values handling: <code>[]</code> will silently return <code>nil</code>, while <code>fetch</code> will raise an error. So, instead of just substituting accessors in our code to a more strict version, let’s think what mutant is actually trying to tell us… And the message is: “There might be a problem with error handling in your code or the test suite does not have a case, forcing your code to suffer from <code>NoMethodError</code> on <code>nil</code> values”.</p>
<p>OK, let’s try to write one:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>it(<span class="vs">'should not raise error on inconsistent configuration'</span>) <span class="cf">do</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  expect <span class="kw">{</span> <span class="dt">Workflow</span><span class="at">.new</span>(<span class="kw">[]</span>)<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span><span class="kw">]</span>)) <span class="kw">}</span><span class="at">.not_to</span> raise_error</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>It predictably fails with old good <code>NotMethodError</code>:</p>
<pre class="console"><code>Workflow
  empty workflow
    should not raise error on inconsistent configuration (FAILED - 1)

Failures:

  1) Workflow empty workflow should not raise error on inconsistent configuration
     Failure/Error: expect { Workflow.new([]).approve(User.new([VOTE])) }.not_to raise_error

       expected no Exception, got #&lt;NoMethodError: undefined method `&lt;&lt;' for nil:NilClass&gt; with backtrace:
         # ./version_2/workflow.rb:36:in `vote'
         # ./version_2/workflow.rb:15:in `approve'
         # ./version_2/workflow_spec.rb:9:in `block (4 levels) in &lt;top (required)&gt;'
         # ./version_2/workflow_spec.rb:9:in `block (3 levels) in &lt;top (required)&gt;'
     # ./version_2/workflow_spec.rb:9:in `block (3 levels) in &lt;top (required)&gt;'

Finished in 0.00971 seconds (files took 0.08025 seconds to load)
1 example, 1 failure</code></pre>
<p>What can we do about it? Let’s actually try to apply the change, suggested by mutant. The <code>vote</code> method now looks like this:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> vote(actor)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@votes</span><span class="at">.fetch</span>(<span class="ot">@current_step</span>) <span class="kw">&lt;&lt;</span> actor</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  increment <span class="cf">if</span> <span class="ot">@votes</span><span class="kw">[</span><span class="ot">@current_step</span><span class="kw">]</span><span class="at">.size</span> <span class="kw">&gt;=</span> <span class="ot">@steps_config</span><span class="kw">[</span><span class="ot">@current_step</span><span class="kw">]</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>Running tests again results in a different <code>IndexError</code> error:</p>
<pre class="console"><code>Workflow
  empty workflow
    should not raise error on inconsistent configuration (FAILED - 1)

Failures:

  1) Workflow empty workflow should not raise error on inconsistent configuration
     Failure/Error: expect { Workflow.new([]).approve(User.new([VOTE])) }.not_to raise_error

       expected no Exception, got #&lt;IndexError: index 0 outside of array bounds: 0...0&gt; with backtrace:
         # ./version_2/workflow.rb:36:in `fetch'
         # ./version_2/workflow.rb:36:in `vote'
         # ./version_2/workflow.rb:15:in `approve'
         # ./version_2/workflow_spec.rb:9:in `block (4 levels) in &lt;top (required)&gt;'
         # ./version_2/workflow_spec.rb:9:in `block (3 levels) in &lt;top (required)&gt;'
     # ./version_2/workflow_spec.rb:9:in `block (3 levels) in &lt;top (required)&gt;'

Finished in 0.01043 seconds (files took 0.0895 seconds to load)
1 example, 1 failure</code></pre>
<p>This one is actually much better to work with. The code blows up exactly where it should, on the code containing accessing error, not later. In the previous run, it failed on <code>&lt;&lt;</code> operator, which in real world examples may be far away from the place containing an error.</p>
<p>OK, we learned something useful, let’s not waste time on actually fixing it properly. Instead, I’ll just pretend <code>IndexError</code> is the desired behavior and replace all hash and array accessing methods to be <code>fetch</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>subject <span class="kw">{</span> <span class="dt">Workflow</span><span class="at">.new</span>(<span class="kw">[]</span>) <span class="kw">}</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>it(<span class="vs">'should raise IndexError on inconsistent configuration'</span>) <span class="cf">do</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  expect <span class="kw">{</span> subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span><span class="kw">]</span>)) <span class="kw">}</span><span class="at">.to</span> raise_error(<span class="dt">IndexError</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>Running mutant again:</p>
<p><a href="https://asciinema.org/a/31227" target="_blank"><img src="https://asciinema.org/a/31227.svg" class="center full" /></a></p>
<p>Better results: <strong>92.95%</strong> What’s next?</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a> def increment</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="st">-  unless finished?</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="st">-    @current_step += 1</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="st">-  end</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="va">+  @current_step += 1</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a> end</span></code></pre></div>
<p>Surprising again. I’m convinced I can fully rely on mutant now and will not try to double-check it once again. It looks like we did not check the case where somebody attempts to work with finished workflow, which forces <code>@current_step</code> variable to increase and <code>@current_step == @steps_config.size</code> invariant does not work anymore. Introducing new test and fixed code:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>subject <span class="kw">{</span> <span class="dt">Workflow</span><span class="at">.new</span>(<span class="kw">[</span><span class="dv">2</span><span class="kw">]</span>) <span class="kw">}</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>it(<span class="vs">'finished workflow not should react on actions'</span>) <span class="cf">do</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  expect <span class="kw">{</span> subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">FORCE</span><span class="kw">]</span>)) <span class="kw">}</span><span class="at">.to</span> change(subject, <span class="wa">:finished?</span>)<span class="at">.from</span>(<span class="dv">false</span>)<span class="at">.to</span>(<span class="dv">true</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  expect <span class="kw">{</span> subject<span class="at">.approve</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">FORCE</span>, <span class="cn">FORCE</span><span class="kw">]</span>)) <span class="kw">}</span><span class="at">.not_to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  expect <span class="kw">{</span> subject<span class="at">.reject</span>(<span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">FORCE</span>, <span class="cn">FORCE</span><span class="kw">]</span>)) <span class="kw">}</span><span class="at">.not_to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> increment</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="cf">if</span> finished?</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@current_step</span> <span class="kw">+=</span> <span class="dv">1</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> decrement</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="cf">if</span> finished?</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@votes</span><span class="kw">[</span><span class="ot">@current_step</span><span class="kw">]</span> <span class="kw">=</span> <span class="dt">Set</span><span class="at">.new</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@current_step</span> <span class="kw">-=</span> <span class="dv">1</span> <span class="cf">unless</span> <span class="ot">@current_step</span> <span class="kw">==</span> <span class="dv">0</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@votes</span><span class="kw">[</span><span class="ot">@current_step</span><span class="kw">]</span> <span class="kw">=</span> <span class="dt">Set</span><span class="at">.new</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>Mutant reports <strong>94.17%</strong> of mutation coverage now, complaining about equality semantics:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a> def finished?</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="st">-  @current_step == @steps_config.size</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="va">+  @current_step.equal?(@steps_config.size)</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a> end</span></code></pre></div>
<p>This is similar to the <code>[]</code> vs <code>fetch</code> case. Mutant again states that using a more strict code (see <a href="http://stackoverflow.com/a/7157051/5346542">here</a> for details) doesn’t brake the tests. In our case it doesn’t matter (<code>equal?</code> on integers is pretty straight-forward), but in real projects, especially with hashes and custom implementation of <code>hash</code> function it may lead to problems. So, we are replacing comparisons with <code>equal?</code> and running mutant:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> finished?</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@current_step</span><span class="at">.equal?</span>(<span class="ot">@steps_config</span><span class="at">.size</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> decrement</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="cf">if</span> finished?</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@votes</span><span class="kw">[</span><span class="ot">@current_step</span><span class="kw">]</span> <span class="kw">=</span> <span class="dt">Set</span><span class="at">.new</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@current_step</span> <span class="kw">-=</span> <span class="dv">1</span> <span class="cf">unless</span> <span class="ot">@current_step</span><span class="at">.zero?</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="ot">@votes</span><span class="kw">[</span><span class="ot">@current_step</span><span class="kw">]</span> <span class="kw">=</span> <span class="dt">Set</span><span class="at">.new</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>Mutation coverage is now <strong>95.25%</strong>, we are close to the finish line:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a> def decrement</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>   if finished?</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>     return</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>   end</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>   @votes[@current_step] = Set.new</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>   unless @current_step.zero?</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>     @current_step -= 1</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>   end</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="st">-  @votes[@current_step] = Set.new</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a> end</span></code></pre></div>
<p>This last line is there to remove any votes on the step, into which the workflow rejects to. I think our tests are only using <code>FORCE</code> permission after the reject operation. That is why removing this line does not break the suite. In fact, there is <code>VOTE</code> activity after <code>reject</code> action in <code>"should be able to reset votes by reject action from #{permission} actor"</code> case, but since workflow contains only one step, <code>@current_step</code> does not get decremented. We need to modify <code>'reject should erase votes from current and previous step'</code> case slightly:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>subject <span class="kw">{</span> <span class="dt">Workflow</span><span class="at">.new</span>(<span class="kw">[</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span><span class="kw">]</span>) <span class="kw">}</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>let(<span class="wa">:voter</span>) <span class="kw">{</span> <span class="kw">-&gt;</span> <span class="kw">{</span> <span class="dt">User</span><span class="at">.new</span>(<span class="kw">[</span><span class="cn">VOTE</span>, <span class="cn">VOTE</span>, <span class="cn">VOTE</span><span class="kw">]</span>) <span class="kw">}</span> <span class="kw">}</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>it(<span class="vs">'reject should erase votes from current and previous step'</span>) <span class="cf">do</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="dv">5</span><span class="at">.times</span> <span class="kw">{</span> subject<span class="at">.approve</span>(voter<span class="at">.call</span>) <span class="kw">}</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  subject<span class="at">.reject</span>(voter<span class="at">.call</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  expect <span class="kw">{</span> <span class="dv">3</span><span class="at">.times</span> <span class="kw">{</span> subject<span class="at">.approve</span>(voter<span class="at">.call</span>) <span class="kw">}</span> <span class="kw">}</span><span class="at">.not_to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  expect <span class="kw">{</span> subject<span class="at">.approve</span>(voter<span class="at">.call</span>) <span class="kw">}</span><span class="at">.to</span> change(subject, <span class="wa">:finished?</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>Now, when all Mutants have been killed, mutant happily reports 100% mutation coverage.</p>
<pre class="console"><code>Mutant configuration:
Matcher:         #&lt;Mutant::Matcher::Config match_expressions: [Workflow]&gt;
Integration:     Mutant::Integration::Rspec
Expect Coverage: 100.00%
Jobs:            8
Includes:        [&quot;.&quot;]
Requires:        [&quot;version_6/workflow_spec.rb&quot;]
Subjects:        7
Mutations:       316
Results:         316
Kills:           316
Alive:           0
Runtime:         8.57s
Killtime:        33.80s
Overhead:        -74.66%
Mutations/s:     36.89
Coverage:        100.00%
Expected:        100.00%</code></pre>
<h2 id="conclusion">Conclusion</h2>
<p>Traditional coverage tools only highlights code which was executed by running a test suite. Let’s run a little thought experiment: squint for a second, blink twice and imagine all assertion checks from your test suite have just disappeared. Will that affect coverage?.. It’s very refreshing to realize it will not. Furthermore, even having full branch coverage does not guarantee you are safe. See <a href="http://pitest.org/weak_tests/">here</a> for examples. Ask yourself a very simple question: are you still sure that the test suite you have is actually able to detect failures in the code?</p>
<p>Besides branch coverage, mutation testing is intended to ensure that code is <em>meaningfully</em> tested, giving your test suite powers to weed broken code out. However, no formal guarantees can be given, it’s a <strong>way</strong> to perfection, not ideal itself.</p>
<p>As a tool, mutant can be used for many tasks. One example is using it as a guide to write better tests (it highlights code paths which were never executed). Or it can be utilized to highlight tests, which are not contributing anymore into branch coverage (deleting such tests will still show <strong>100%</strong> mutation coverage).</p>
<p>I personally don’t always use mutant in my day-to-day development job, and I’m not here to convince you absolutely must. But it helps to better understand and improve your code and coding skills in general. To explore different mutation operators mutant can apply to your code, see <a href="https://github.com/mbj/mutant/tree/master/meta">here</a>. Give it a try some time in the future!</p>
  </section>
</article>

<div id="disqus_thread"></div>
<script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://https-maksar-github-io.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </main>

  <footer>
    <a type="application/rss+xml" href="../../../rss.xml">RSS Feed</a>
    Site generated by
    <a href="http://jaspervdj.be/hakyll">Hakyll</a>
  </footer>
</body>
</html>